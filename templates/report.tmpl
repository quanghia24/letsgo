<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Product Comparison Report</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    :root{
      --query: #2c3e50; /* dark blue */
      --local: #3498db; /* blue */
      --api: #e74c3c;   /* red */
      --matched: #27ae60; /* green */
    }
    body { background:#f8fafc; color:#1e293b; }
    .card { background:white; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06); }
    .badge { @apply px-2 py-1 text-xs font-medium rounded-full; }
    .rapid { background: rgba(52,152,219,0.08); color: var(--local); padding:4px 8px; border-radius:6px }
    .ali { background: rgba(231,76,60,0.06); color: var(--api); padding:4px 8px; border-radius:6px }
    .error { background: rgba(231,76,60,0.06); color: #b03a2e; padding:4px 8px; border-radius:6px }
    .variant-card.matched { border-color: var(--matched) !important; background: rgba(39,174,96,0.06) }
    .line-clamp-2 { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden }
    .prod-img { height:200px; width:100%; object-fit:cover }
    /* Summary panel */
    #summaryPanel{ position:fixed; left:0; right:0; bottom:0; transform:translateY(120%); transition:transform 300ms ease-in-out; z-index:60 }
    #summaryPanel.active{ transform:translateY(0) }
    #summaryPanel .panel{ background:white; box-shadow:0 -6px 24px rgba(0,0,0,0.12); padding:16px; border-top:4px solid var(--local) }
    .price-red{ color: #e74c3c; font-weight:700 }
  </style>
</head>
<body class="antialiased">
  <div id="mainContent" class="w-full mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-10">
      <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-3">
        <i class="fas fa-search-dollar text-indigo-600"></i>
        Product Comparison Report
      </h1>
      <div class="text-sm text-gray-500 mt-2 sm:mt-0">
        Generated: <span class="font-medium">{{.GeneratedAt}}</span>
      </div>
    </div>

    <!-- Products Grid -->
    <div class="flex flex-row">
      <h1 class="w-1/5 text-xl font-bold justify-center flex items-center">Product</h1>
      <h1 class="w-2/5 text-xl font-semibold text-gray-800 mb-4 flex items-center justify-center gap-2">
        <i class="fab fa-superpowers text-blue-600"></i> RapidAPI
      </h1>
      <h1 class="w-2/5 text-xl font-semibold text-gray-800 mb-4 flex items-center justify-center gap-2">
        <i class="fab fa-alipay text-green-600"></i> AliHunter
      </h1>
    </div>

    {{range $idx, $r := .Comparisons}}
    <div class="flex flex-row justify-evenly card rounded-xl overflow-hidden mb-8">
      <!-- Input Product -->
      <div class="bg-gradient-to-r from-cyan-500 to-blue-600 text-white p-4 w-1/5">
        <div class="flex flex-col items-center justify-between">
          {{if $r.ImageURL}}
            <img src="{{$r.ImageURL}}" alt="Product" class="w-60 h-60 rounded-lg border-4 border-white shadow-lg object-cover">
          {{end}}
          <h2 class="text-xl font-semibold">ID: <span class="font-mono">{{$r.ProductID}}</span></h2>
        </div>
      </div>

      <!-- Request Error -->
      {{if $r.AliError}}
        <div class="px-6 py-3 bg-red-50 border-l-4 border-red-500 text-red-700 flex items-center gap-2">
          <i class="fas fa-exclamation-triangle"></i>
          <span>AliHunter error: {{$r.AliError}}</span>
        </div>
      {{end}}

      <!-- RapidAPI Results -->
      <div class="border w-2/5">
        {{if $r.RapidTop}}
          <div class="flex flex-row justify-evenly">
            {{range $i, $p := $r.RapidTop}}
            <div class="variant-card flex-1 flex flex-col border border-gray-200 rounded-lg p-4 hover:border-indigo-300 transition relative">
              {{if $p.ProductMainImageURL}}
                <img src="{{$p.ProductMainImageURL}}" alt="Product" class="rounded-lg border-4 border-white shadow-lg prod-img mb-3">
              {{end}}

              <h4 class="font-medium text-gray-900 mt-2 line-clamp-2">{{$p.ProductTitle}}</h4>
              <div class="mt-2 text-sm text-gray-600 space-y-1">
                <div><strong class="price-red">{{if $p.TargetSalePrice}}{{$p.TargetSalePrice}}{{else}}N/A{{end}}</strong></div>
                <div>Rating: {{if $p.Avgstar}}{{printf "%.1f" $p.Avgstar}}{{else}}-{{end}} ⭐</div>
              </div>
              <a href="{{$p.ProductURL}}" target="_blank" class="mt-3 inline-flex items-center text-indigo-600 hover:text-indigo-800 font-medium text-sm">
                View on platform <i class="ml-1 fas fa-external-link-alt"></i>
              </a>
              <label class="flex items-center gap-2 text-sm p-2">
                <input type="checkbox" class="match-checkbox" id="chk-{{$idx}}-local-{{$i}}" data-col="local" data-productid="{{$r.ProductID}}" data-title="{{$p.ProductTitle}}" data-price="{{$p.TargetSalePrice}}" data-img="{{$r.ImageURL}}" data-link="{{$p.ProductURL}}">
                <span>Match Original</span>
              </label>
            </div>
            {{end}}
          </div>
        {{else}}
          <p class="text-gray-500 italic">No RapidAPI results found</p>
        {{end}}
      </div>

      <!-- AliHunter Results -->
      <div class="border w-2/5">
        {{if $r.AliTop}}
          <div class="flex flex-row justify-evenly">
            {{range $i, $p := $r.AliTop}}
            <div class="variant-card flex-1 flex flex-col border border-gray-200 rounded-lg p-4 hover:border-green-300 transition relative">
              {{if $p.ProductMainImageURL}}
                <img src="{{$p.ProductMainImageURL}}" alt="Product" class="rounded-lg border-4 border-white shadow-lg prod-img mb-3">
              {{end}}

              <h4 class="font-medium text-gray-900 mt-2 line-clamp-2">{{$p.ProductTitle}}</h4>
              <div class="mt-2 text-sm text-gray-600 space-y-1">
                <div><strong class="price-red">{{if $p.TargetSalePrice}}{{formatPrice $p.TargetSalePrice}}{{else}}N/A{{end}}</strong></div>
                <div>Rating: {{if $p.EvaluateRate}}{{$p.EvaluateRate}}{{else}}0{{end}} ⭐</div>
              </div>
              <a href="{{$p.ProductDetailURL}}" target="_blank" class="mt-3 inline-flex items-center text-green-600 hover:text-green-800 font-medium text-sm">
                View on AliExpress <i class="ml-1 fas fa-external-link-alt"></i>
              </a>
              <label class="flex items-center gap-2 text-sm p-2">
                <input type="checkbox" class="match-checkbox" id="chk-{{$idx}}-api-{{$i}}" data-col="api" data-productid="{{$r.ProductID}}" data-title="{{$p.ProductTitle}}" data-price="{{formatPrice $p.TargetSalePrice}}" data-img="{{$r.ImageURL}}" data-link="{{$p.ProductDetailURL}}">
                <span>Match Original</span>
              </label>
            </div>
            {{end}}
          </div>
        {{else}}
          <p class="text-gray-500 italic">No AliHunter results{{if $r.AliError}} – {{$r.AliError}}{{end}}</p>
        {{end}}
      </div>

    </div>
    {{end}}
  </div>

  <!-- Summary panel (hidden until a checkbox is selected) -->
    <div id="summaryPanel" class="flex justify-center">
      <div class="panel p-4 bg-white rounded shadow-lg">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-xl text-gray-600">Total queries processed: <strong id="totalQueries">{{len .Comparisons}}</strong></div>
            <div class="text-xl text-gray-600">Local matches: <strong id="localCount">0</strong> (<span id="localPct">0%</span>)</div>
            <div class="text-xl text-gray-600">API matches: <strong id="apiCount">0</strong> (<span id="apiPct">0%</span>)</div>
          </div>
          <div class="flex items-center gap-3">
            <button id="copyBtn" class="px-3 py-2 bg-blue-600 text-white rounded">Copy to clipboard</button>
            <button id="closeSummary" class="px-3 py-2 bg-gray-200 rounded">Close</button>
          </div>
        </div>

        <div class="mt-4">
          <table class="w-full text-lg" id="checkedTable">
            <thead>
              <tr class="text-left text-gray-600 text-xl">
                <th class="px-2">Product ID</th>
                <th class="px-2">Source</th>
                <th class="px-2">Title</th>
                <th class="px-2">Price</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      (function(){
        const totalQueries = {{len .Comparisons}};
        const summaryPanel = document.getElementById('summaryPanel');
        const mainContent = document.getElementById('mainContent');
        const localCountEl = document.getElementById('localCount');
        const apiCountEl = document.getElementById('apiCount');
        const localPctEl = document.getElementById('localPct');
        const apiPctEl = document.getElementById('apiPct');
        const checkedTableBody = document.querySelector('#checkedTable tbody');
        const copyBtn = document.getElementById('copyBtn');
        const closeBtn = document.getElementById('closeSummary');

        function updateState(){
          const localChecked = Array.from(document.querySelectorAll('.match-checkbox[data-col="local"]:checked'));
          const apiChecked = Array.from(document.querySelectorAll('.match-checkbox[data-col="api"]:checked'));

          // toggle matched class for cards
          document.querySelectorAll('.variant-card').forEach(card => {
            const cb = card.querySelector('.match-checkbox');
            if(cb && cb.checked){ card.classList.add('matched'); } else { card.classList.remove('matched'); }
          });

          // Count total available checkboxes for each source
          const totalLocalCheckboxes = document.querySelectorAll('.match-checkbox[data-col="local"]').length;
          const totalApiCheckboxes = document.querySelectorAll('.match-checkbox[data-col="api"]').length;

          // Display total individual items checked
          localCountEl.textContent = localChecked.length;
          apiCountEl.textContent = apiChecked.length;

          // Calculate percentage based on checked items vs total available items
          localPctEl.textContent = totalLocalCheckboxes ? Math.round((localChecked.length/totalLocalCheckboxes)*100) + '%' : '0%';
          apiPctEl.textContent = totalApiCheckboxes ? Math.round((apiChecked.length/totalApiCheckboxes)*100) + '%' : '0%';

          // build table of checked items
          const allChecked = localChecked.concat(apiChecked);
          checkedTableBody.innerHTML = '';
          allChecked.forEach(cb => {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td class="px-2">'+cb.dataset.productid+'</td>'+
                           '<td class="px-2">'+(cb.dataset.col==='local' ? 'Local' : 'API')+'</td>'+
                           '<td class="px-2">'+cb.dataset.title+'</td>'+
                           '<td class="px-2">'+cb.dataset.price+'</td>';
            checkedTableBody.appendChild(tr);
          });

          // show/hide panel
          if(allChecked.length > 0){
            summaryPanel.classList.add('active');
            // ensure main content isn't covered by the fixed panel
            const panelEl = summaryPanel.querySelector('.panel');
            if(panelEl && mainContent){
              mainContent.style.paddingBottom = panelEl.offsetHeight + 'px';
            }
          } else {
            summaryPanel.classList.remove('active');
            if(mainContent){ mainContent.style.paddingBottom = ''; }
          }
        }

        // attach listeners
        document.querySelectorAll('.match-checkbox').forEach(cb => cb.addEventListener('change', updateState));

        copyBtn.addEventListener('click', async () => {
          const rows = Array.from(checkedTableBody.querySelectorAll('tr')).map(tr => {
            return Array.from(tr.children).map(td => td.textContent.trim()).join('\t');
          }).join('\n');
          try{
            await navigator.clipboard.writeText(rows);
            copyBtn.textContent = 'Copied!';
            setTimeout(()=> copyBtn.textContent = 'Copy to clipboard', 1500);
          }catch(e){
            alert('Copy failed: '+e);
          }
        });

        closeBtn.addEventListener('click', ()=>{ document.querySelectorAll('.match-checkbox').forEach(cb=>cb.checked=false); updateState(); });

        // initialize
        updateState();
      })();
    </script>
  </body>
</html>