<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Product Comparison Report</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    :root{
      --query: #2c3e50; /* dark blue */
      --local: #3498db; /* blue */
      --alihunter: #e74c3c;   /* red */
      --matched: #27ae60; /* green */
    }
    body { background:#f8fafc; color:#1e293b; }
    .card { background:white; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06); }
    .badge { @apply px-2 py-1 text-xs font-medium rounded-full; }
    .rapid { background: rgba(52,152,219,0.08); color: var(--local); padding:4px 8px; border-radius:6px }
    .ali { background: rgba(231,76,60,0.06); color: var(--alihunter); padding:4px 8px; border-radius:6px }
    .error { background: rgba(231,76,60,0.06); color: #b03a2e; padding:4px 8px; border-radius:6px }
    .variant-card.matched { border-color: var(--matched) !important; background: rgba(39,174,96,0.06) }
    .line-clamp-2 { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden }
    .prod-img { height:100%; width:120px; object-fit:cover }
    /* Summary panel */
    #summaryPanel{ position:fixed; left:0; right:0; bottom:0; transform:translateY(120%); transition:transform 300ms ease-in-out; z-index:60 }
    #summaryPanel.active{ transform:translateY(0) }
    #summaryPanel .panel{ background:white; box-shadow:0 -6px 24px rgba(0,0,0,0.12); padding:16px; border-top:4px solid var(--local) }
    .price-red{ color: #e74c3c; font-weight:700 }
  </style>
</head>
<body class="antialiased">
  <div id="mainContent" class="w-full mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-10">
      <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-3">
        <i class="fas fa-search-dollar text-indigo-600"></i>
        Product Comparison Report
      </h1>
      <div class="text-sm text-gray-500 mt-2 sm:mt-0">
        Generated: <span class="font-medium">{{.GeneratedAt}}</span>
      </div>
    </div>

    <!-- Products Grid -->
    <div class="flex flex-row justify-evenly">
      <h1 class="w-1/5 text-xl font-bold justify-center">Product</h1>
      <h1 class="w-1/4 text-xl font-semibold text-gray-800 mb-4">
        <i class="fab fa-superpowers text-blue-600"></i> RapidAPI
      </h1>
      <h1 class="w-1/4 text-xl font-semibold text-gray-800 mb-4">
        <i class="fab fa-alipay text-green-600"></i> AliHunter
      </h1>
      <h1 class="w-1/4 text-xl font-semibold text-gray-800 mb-4">
        <i class="fas fa-shopping-cart text-orange-600"></i> AliExpress
      </h1>
    </div>


    {{range $idx, $r := .Comparisons}}
    <div class="flex flex-row justify-evenly card rounded-xl overflow-hidden mb-8">
      <!-- Input Product -->
      <div class="bg-gradient-to-r from-white to-blue-100 text-white p-4 rounded-lg w-1/5 flex items-center justify-center">
        <div class="flex flex-col items-center justify-between">
          {{if $r.ImageURL}}
            <img src="{{$r.ImageURL}}" alt="Product" class="w-60 h-60 rounded-lg border-4 border-white shadow-lg object-cover">
          {{end}}
          <h2 class="text-black text-xl font-semibold">ID: <span class="font-mono">{{$r.ProductID}}</span></h2>
        </div>
      </div>

      <!-- RapidAPI Results -->
      <div class="w-1/4 rounded-lg">
        {{if $r.LocalRapidAPITop}}
          <div class="flex flex-col justify-evenly gap-2">
            {{range $i, $p := $r.LocalRapidAPITop}}
            <div class="variant-card flex-1 flex flex-row border border-2 rounded-lg p-4 hover:border-indigo-300 transition relative bg-gradient-to-r from-blue-100 to-blue-200">
              {{if $p.ProductMainImageURL}}
                <img src="{{$p.ProductMainImageURL}}" alt="Product" class="rounded-lg border-4 border-white shadow-lg prod-img mr-3">
              {{end}}
              <div>
                <a class="font-medium text-gray-900 mt-2 line-clamp-2" href="{{$p.ProductURL}}" target="_blank">{{$p.ProductTitle}}</a>
                <div class="mt-2 text-sm text-gray-600 space-y-1">
                  <div><strong class="price-red">{{if $p.TargetSalePrice}}{{$p.TargetSalePrice}}{{else}}N/A{{end}}</strong></div>
                  <div>Rating: {{if $p.Avgstar}}{{printf "%.1f" $p.Avgstar}}{{else}}-{{end}} ⭐</div>
                </div>
                <label class="flex items-center gap-2 text-sm">
                  <input type="checkbox" class="match-checkbox" id="chk-{{$idx}}-local-{{$i}}" data-col="local" data-productid="{{$r.ProductID}}" data-title="{{$p.ProductTitle}}" data-price="{{$p.TargetSalePrice}}" data-img="{{$r.ImageURL}}" data-link="{{$p.ProductURL}}" data-rating="{{if $p.Avgstar}}{{printf "%.1f" $p.Avgstar}}{{else}}0{{end}}">
                  <span>Match Original</span>
                </label>
              </div>
            </div>
            {{end}}
          </div>
        {{else}}
          <p class="text-gray-500 italic">No RapidAPI results found</p>
        {{end}}
      </div>

      <!-- AliHunter Results -->
      <div class="w-1/4 rounded-lg">
        {{if $r.AliHunterTop}}
          <div class="flex flex-col justify-evenly gap-2">
            {{range $i, $p := $r.AliHunterTop}}
            <div class="variant-card flex-1 flex flex-row border border-2 rounded-lg p-4 hover:border-green-300 transition relative bg-gradient-to-r from-green-100 to-green-200">
              {{if $p.ProductMainImageURL}}
                <img src="{{$p.ProductMainImageURL}}" alt="Product" class="rounded-lg border-4 border-white shadow-lg prod-img mr-3">
              {{end}}

              <div>
                <a class="font-medium text-gray-900 mt-2 line-clamp-2" href="{{$p.ProductDetailURL}}" target="_blank">{{$p.ProductTitle}}</a>
                <div class="mt-2 text-sm text-gray-600 space-y-1">
                  <div><strong class="price-red">{{if $p.TargetSalePrice}}{{formatPrice $p.TargetSalePrice}}{{else}}N/A{{end}}</strong></div>
                  <div>Rating: {{if $p.EvaluateRate}}{{$p.EvaluateRate}}{{else}}0{{end}} ⭐</div>
                </div>
                <label class="flex items-center gap-2 text-sm">
                  <input type="checkbox" class="match-checkbox" id="chk-{{$idx}}-alihunter-{{$i}}" data-col="alihunter" data-productid="{{$r.ProductID}}" data-title="{{$p.ProductTitle}}" data-price="{{formatPrice $p.TargetSalePrice}}" data-img="{{$r.ImageURL}}" data-link="{{$p.ProductDetailURL}}" data-rating="{{if $p.EvaluateRate}}{{$p.EvaluateRate}}{{else}}0{{end}}">
                  <span>Match Original</span>
                </label>
              </div>
            </div>
            {{end}}
          </div>
        {{else}}
          <p class="text-gray-500 italic">No AliHunter results</p>
        {{end}}
      </div>

      <!-- AliExpress Results -->
      <div class="w-1/4 rounded-lg">
        {{if $r.AliExpressTop}}
          <div class="flex flex-col justify-evenly gap-2">
            {{range $i, $p := $r.AliExpressTop}}
            <div class="variant-card flex-1 flex flex-row border border-2 rounded-lg p-4 hover:border-orange-300 transition relative bg-gradient-to-r from-orange-100 to-white ">
              {{if $p.ImageURL}}
                <img src="https:{{$p.ImageURL}}" alt="Product" class="rounded-lg border-4 border-white shadow-lg prod-img mr-3">
              {{end}}

              <div>
                <a class="font-medium text-gray-900 mt-2 line-clamp-2" href="{{$p.URL}}" target="_blank">{{$p.Title}}</a>
                <div class="mt-2 text-sm text-gray-600 space-y-1">
                  <div><strong class="price-red">{{if $p.SalePrice}}${{printf "%.2f" $p.SalePrice}}{{else}}N/A{{end}}</strong></div>
                  <div>Rating: {{if $p.AvgRatingStar}}{{printf "%.1f" $p.AvgRatingStar}}{{else}}0{{end}} ⭐</div>
                </div>
                <label class="flex items-center gap-2 text-sm">
                  <input type="checkbox" class="match-checkbox" id="chk-{{$idx}}-aliexpress-{{$i}}" data-col="aliexpress" data-productid="{{$r.ProductID}}" data-title="{{$p.Title}}" data-price="${{printf "%.2f" $p.SalePrice}}" data-img="https:{{$r.ImageURL}}" data-link="https:{{$p.URL}}" data-rating="{{if $p.AvgRatingStar}}{{printf "%.1f" $p.AvgRatingStar}}{{else}}0{{end}}">
                  <span>Match Original</span>
                </label>
              </div>
            </div>
            {{end}}
          </div>
        {{else}}
          <p class="text-gray-500 italic">No AliExpress results</p>
        {{end}}
      </div>
    </div>
    {{end}}
  </div>

  <!-- Summary panel (hidden until a checkbox is selected) -->
    <div id="summaryPanel" class="flex justify-center">
      <div class="panel p-4 bg-white rounded shadow-lg">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-xl text-gray-600">Total queries processed: <strong id="totalQueries">{{len .Comparisons}}</strong></div>
            <div class="text-xl text-gray-600">RapidAPI matches: <strong id="localCount">0</strong> (<span id="localPct">0%</span>)</div>
            <div class="text-xl text-gray-600">AliHunter matches: <strong id="alihunterCount">0</strong> (<span id="alihunterPct">0%</span>)</div>
            <div class="text-xl text-gray-600">AliExpress matches: <strong id="aliexpressCount">0</strong> (<span id="aliexpressPct">0%</span>)</div>
          </div>
          <div class="flex items-center gap-3">
            <button id="exportBtn" class="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition flex items-center gap-2">
              <i class="fas fa-download"></i> Export to JSON
            </button>
            <button id="closeSummary" class="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300 transition">Close</button>
          </div>
        </div>

        <div class="mt-4">
          <table class="w-full text-lg" id="checkedTable">
            <thead>
              <tr class="text-left text-gray-600 text-xl">
                <th class="px-2">Product ID</th>
                <th class="px-2">Source</th>
                <th class="px-2">Title</th>
                <th class="px-2">Price</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      (function(){
        const totalQueries = {{len .Comparisons}};
        const summaryPanel = document.getElementById('summaryPanel');
        const mainContent = document.getElementById('mainContent');
        const localCountEl = document.getElementById('localCount');
        const alihunterCountEl = document.getElementById('alihunterCount');
        const aliexpressCountEl = document.getElementById('aliexpressCount');
        const localPctEl = document.getElementById('localPct');
        const alihunterPctEl = document.getElementById('alihunterPct');
        const aliexpressPctEl = document.getElementById('aliexpressPct');
        const checkedTableBody = document.querySelector('#checkedTable tbody');
        const exportBtn = document.getElementById('exportBtn');
        const closeBtn = document.getElementById('closeSummary');

        // Store the original data from the server
        const comparisonsData = {{.Comparisons | printf "%#v"}};

        function updateState(){
          const localChecked = Array.from(document.querySelectorAll('.match-checkbox[data-col="local"]:checked'));
          const alihunterChecked = Array.from(document.querySelectorAll('.match-checkbox[data-col="alihunter"]:checked'));
          const aliexpressChecked = Array.from(document.querySelectorAll('.match-checkbox[data-col="aliexpress"]:checked'));

          // toggle matched class for cards
          document.querySelectorAll('.variant-card').forEach(card => {
            const cb = card.querySelector('.match-checkbox');
            if(cb && cb.checked){ card.classList.add('matched'); } else { card.classList.remove('matched'); }
          });

          // Count total available checkboxes for each source
          const totalLocalCheckboxes = document.querySelectorAll('.match-checkbox[data-col="local"]').length;
          const totalAlihunterCheckboxes = document.querySelectorAll('.match-checkbox[data-col="alihunter"]').length;
          const totalAliexpressCheckboxes = document.querySelectorAll('.match-checkbox[data-col="aliexpress"]').length;

          // Display total individual items checked
          localCountEl.textContent = localChecked.length;
          alihunterCountEl.textContent = alihunterChecked.length;
          aliexpressCountEl.textContent = aliexpressChecked.length;

          // Calculate percentage based on checked items vs total available items
          localPctEl.textContent = totalLocalCheckboxes ? Math.round((localChecked.length/totalLocalCheckboxes)*100) + '%' : '0%';
          alihunterPctEl.textContent = totalAlihunterCheckboxes ? Math.round((alihunterChecked.length/totalAlihunterCheckboxes)*100) + '%' : '0%';
          aliexpressPctEl.textContent = totalAliexpressCheckboxes ? Math.round((aliexpressChecked.length/totalAliexpressCheckboxes)*100) + '%' : '0%';

          // build table of checked items
          const allChecked = localChecked.concat(alihunterChecked).concat(aliexpressChecked);
          checkedTableBody.innerHTML = '';
          allChecked.forEach(cb => {
            const tr = document.createElement('tr');
            let sourceName = 'Unknown';
            if(cb.dataset.col === 'local') sourceName = 'RapidAPI';
            else if(cb.dataset.col === 'alihunter') sourceName = 'AliHunter';
            else if(cb.dataset.col === 'aliexpress') sourceName = 'AliExpress';
            tr.innerHTML = '<td class="px-2">'+cb.dataset.productid+'</td>'+
                           '<td class="px-2">'+sourceName+'</td>'+
                           '<td class="px-2">'+cb.dataset.title+'</td>'+
                           '<td class="px-2">'+cb.dataset.price+'</td>';
            checkedTableBody.appendChild(tr);
          });

          // show/hide panel
          if(allChecked.length > 0){
            summaryPanel.classList.add('active');
            // ensure main content isn't covered by the fixed panel
            const panelEl = summaryPanel.querySelector('.panel');
            if(panelEl && mainContent){
              mainContent.style.paddingBottom = panelEl.offsetHeight + 'px';
            }
          } else {
            summaryPanel.classList.remove('active');
            if(mainContent){ mainContent.style.paddingBottom = ''; }
          }
        }

        // attach listeners
        document.querySelectorAll('.match-checkbox').forEach(cb => cb.addEventListener('change', updateState));

        exportBtn.addEventListener('click', () => {
          // Build export data structure
          const exportData = {
            total_products: totalQueries,
            comparisons: []
          };

          // Get all checkboxes organized by product
          const productGroups = {};
          document.querySelectorAll('.match-checkbox').forEach(cb => {
            const prodId = cb.dataset.productid;
            if (!productGroups[prodId]) {
              productGroups[prodId] = {
                product_id: prodId,
                image_url: cb.dataset.img,
                rapidapi_products: [],
                alihunter_products: [],
                aliexpress_products: []
              };
            }

            const productData = {
              product_title: cb.dataset.title,
              price: cb.dataset.price,
              rating: cb.dataset.rating,
              product_url: cb.dataset.link,
              matching: cb.checked
            };

            if (cb.dataset.col === 'local') {
              productGroups[prodId].rapidapi_products.push(productData);
            } else if (cb.dataset.col === 'alihunter') {
              productGroups[prodId].alihunter_products.push(productData);
            } else if (cb.dataset.col === 'aliexpress') {
              productGroups[prodId].aliexpress_products.push(productData);
            }
          });

          // Convert to array
          exportData.comparisons = Object.values(productGroups);

          // Create JSON blob and download
          const jsonStr = JSON.stringify(exportData, null, 2);
          const blob = new Blob([jsonStr], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `comparison.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          // Visual feedback
          const originalHTML = exportBtn.innerHTML;
          exportBtn.innerHTML = '<i class="fas fa-check"></i> Exported!';
          exportBtn.disabled = true;
          setTimeout(() => {
            exportBtn.innerHTML = originalHTML;
            exportBtn.disabled = false;
          }, 2000);
        });

        closeBtn.addEventListener('click', ()=>{ document.querySelectorAll('.match-checkbox').forEach(cb=>cb.checked=false); updateState(); });

        // initialize
        updateState();
      })();
    </script>
  </body>
</html>